{% extends 'base.html' %}

{% block title %}QR Code Generated - {{ record.name }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">

            <div id="processingSection" class="card border-0 shadow-lg p-5 text-center">
                <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;"></div>
                <h3 class="fw-bold mb-3 text-primary">Finalizing Your Secure QR Code</h3>
                <p id="processingMessage" class="text-muted fs-5">Initiating secure connection...</p>

                <div class="progress mt-4" style="height: 8px;">
                    <div id="progressFill" class="progress-bar bg-primary progress-bar-striped progress-bar-animated"
                        style="width: 0%"></div>
                </div>

                <ul id="statusList" class="list-group list-group-flush text-start mt-4">
                    <li class="list-group-item d-flex align-items-center"><i class="fas fa-dot-circle me-2 text-muted"></i> Initiating secure connection...</li>
                    <li class="list-group-item d-flex align-items-center"><i class="fas fa-dot-circle me-2 text-muted"></i> Verifying payment details...</li>
                    <li class="list-group-item d-flex align-items-center"><i class="fas fa-dot-circle me-2 text-muted"></i> Encrypting your data...</li>
                    <li class="list-group-item d-flex align-items-center"><i class="fas fa-dot-circle me-2 text-muted"></i> Uploading documents to Cloudinary...</li>
                    <li class="list-group-item d-flex align-items-center"><i class="fas fa-dot-circle me-2 text-muted"></i> Generating the QR code image...</li>
                    <li class="list-group-item d-flex align-items-center"><i class="fas fa-dot-circle me-2 text-muted"></i> Attaching QR code to your record...</li>
                    <li class="list-group-item d-flex align-items-center"><i class="fas fa-dot-circle me-2 text-muted"></i> Finalizing all processes...</li>
                </ul>
            </div>

            <div id="successSection" class="card border-0 shadow-lg p-5 text-center d-none animate__animated animate__fadeIn">
                
                {% if order_type == 'pvc' or order_type == 'nfc' %}
                <div class="alert alert-success animate__animated animate__pulse" style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);">
                    <div style="font-size: 22px; margin-bottom: 20px;">
                        <i class="fas fa-shipping-fast" style="color: #28a745; margin-right: 12px; font-size: 24px;"></i>
                        <strong>ðŸŽ‰ Order Successfully Placed!</strong>
                    </div>
                    
                    <div style="font-size: 16px; line-height: 2.0; text-align: left;">
                        <div class="row">
                            <div class="col-12">
                                <p style="margin: 10px 0;"><i class="fas fa-check-circle" style="color: #28a745; margin-right: 8px;"></i><strong>Admin notification sent successfully</strong></p>
                                <p style="margin: 10px 0;"><i class="fas fa-box" style="color: #17a2b8; margin-right: 8px;"></i>Your <strong>{% if order_type == 'pvc' %}PVC Card{% else %}NFC Card{% endif %}</strong> will be prepared and delivered within <strong>5 working days</strong></p>
                                <p style="margin: 10px 0;"><i class="fas fa-map-marker-alt" style="color: #dc3545; margin-right: 8px;"></i><strong>Delivery Address:</strong> {{ record.address }}</p>
                                <p style="margin: 10px 0;"><i class="fas fa-phone" style="color: #007bff; margin-right: 8px;"></i>For queries, contact: <strong><a href="tel:9886289293" style="color: #007bff; text-decoration: none;">9886289293</a></strong></p>
                            </div>
                        </div>
                        <hr style="border-color: #c3e6cb; margin: 20px 0;">
                        <p style="color: #6c757d; font-size: 14px; text-align: center; margin: 15px 0 0 0; font-style: italic;">
                            <i class="fas fa-envelope" style="margin-right: 6px;"></i>You will receive email updates about your order status
                        </p>
                    </div>
                </div>
                {% endif %}

                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                </div>
                <h2 class="fw-bold text-success">QR Code Ready</h2>
                <p class="text-muted">Your secure QR code is now generated and ready for use.</p>

                {% if record.qr_code_image %}
                <div class="my-4 animate__animated animate__zoomIn">
                    <img src="{{ record.qr_code_image.url }}"
                        alt="QR Code for {{ record.name }}"
                        class="img-fluid border rounded shadow-lg"
                        style="max-width: 250px;">
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Scan this QR code anytime to securely access your documents.
                </div>

                <div class="d-flex flex-wrap justify-content-center gap-3 mt-3">
                    <a href="{{ record.qr_code_image.url }}" class="btn btn-primary btn-lg"
                        download="qr_code_{{ record.name|slugify }}.png">
                        <i class="fas fa-download me-2"></i>Download QR
                    </a>
                    {% if record.gallery_html_url %}
                    <a href="{{ record.gallery_html_url }}" class="btn btn-success btn-lg" target="_blank">
                        <i class="fas fa-external-link-alt me-2"></i>View Documents
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-warning">QR code is still generating. Please refresh shortly.</div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

<script>
    const messages = [
        "Initiating secure connection...",
        "Verifying payment details...",
        "Encrypting your data...",
        "Uploading documents to Cloudinary...",
        "Generating the QR code image...",
        "Attaching QR code to your record...",
        "Finalizing all processes..."
    ];

    let step = 0;
    const msgEl = document.getElementById("processingMessage");
    const progressFill = document.getElementById("progressFill");
    const statusList = document.getElementById("statusList").children;
    const processingSection = document.getElementById("processingSection");
    const successSection = document.getElementById("successSection");

    function showNextMessage() {
        if (step < messages.length) {
            msgEl.textContent = messages[step];
            progressFill.style.width = ((step + 1) / messages.length) * 100 + "%";

            if (step > 0) {
                statusList[step - 1].children[0].className = "fas fa-check-circle me-2 text-success";
            }
            statusList[step].children[0].className = "fas fa-sync-alt fa-spin me-2 text-primary";

            step++;
        } else {
            statusList[messages.length - 1].children[0].className = "fas fa-check-circle me-2 text-success";

            setTimeout(() => {
                processingSection.classList.add("d-none");
                successSection.classList.remove("d-none");
            }, 1000);
        }
    }

    const totalTimeInSeconds = 30;
    const intervalTime = (totalTimeInSeconds / messages.length) * 1000;
    
    showNextMessage();
    setInterval(showNextMessage, intervalTime);
</script>
{% endblock %}
