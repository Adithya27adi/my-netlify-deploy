{% extends 'base.html' %}

{% block title %}Create {{ record_type|title }} Record{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h2 class="fw-bold">Create {{ record_type|title }} Record</h2>
                        <p class="text-muted">Upload up to 4 documents and pay ₹2 to get your QR code</p>
                    </div>

                    <!-- Personal Information Form -->
                    <form id="recordForm">
                        {% csrf_token %}
                        <input type="hidden" id="recordType" value="{{ record_type }}">
                        
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Full Name *</label>
                                <input type="text" id="fullName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Contact Number *</label>
                                <input type="tel" id="contactNo" class="form-control" pattern="[0-9]{10}" required>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label fw-semibold">Address *</label>
                                <textarea id="address" class="form-control" rows="3" required></textarea>
                            </div>
                        </div>

                        <!-- Document Upload Section -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">Upload Documents</h5>
                            <div class="text-center">
                                <button type="button" id="uploadBtn" class="btn btn-primary btn-lg">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>Upload Documents
                                </button>
                                <p class="text-muted mt-2">Upload up to 4 images/PDFs (Max 10MB each)</p>
                            </div>
                            
                            <!-- Upload Progress -->
                            <div id="uploadProgress" class="mt-3" style="display: none;">
                                <div class="progress mb-2">
                                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <p class="text-center mb-0" id="uploadStatus">Uploading...</p>
                            </div>

                            <!-- Uploaded Files Preview -->
                            <div id="uploadedFiles" class="row mt-3" style="display: none;"></div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" id="submitBtn" class="btn btn-success btn-lg px-5" disabled>
                                <i class="fas fa-credit-card me-2"></i>Proceed to Payment (₹2)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cloudinary Upload Widget -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<script>
let uploadedUrls = [];

// Initialize Cloudinary widget
const myWidget = cloudinary.createUploadWidget({
    cloudName: 'dwqq1jtzm', // Replace with your cloud name
    uploadPreset: 'unsigned_upload',    // Replace with your preset
    multiple: true,
    maxFiles: 4,
    maxFileSize: 10485760, // 10MB
    clientAllowedFormats: ['jpg', 'png', 'jpeg', 'pdf'],
    showProgressBar: true,
    showUploadMoreButton: false
}, (error, result) => {
    if (!error && result && result.event === "success") {
        console.log('Upload successful:', result.info);
        uploadedUrls.push(result.info.secure_url);
        updateUploadedFilesPreview();
        
        if (uploadedUrls.length > 0) {
            document.getElementById('submitBtn').disabled = false;
        }
    }
    
    if (result && result.event === "queues-end") {
        document.getElementById('uploadProgress').style.display = 'none';
    }
});

// Upload button click handler
document.getElementById('uploadBtn').addEventListener('click', function() {
    document.getElementById('uploadProgress').style.display = 'block';
    myWidget.open();
});

// Update preview of uploaded files
function updateUploadedFilesPreview() {
    const container = document.getElementById('uploadedFiles');
    container.innerHTML = '';
    
    uploadedUrls.forEach((url, index) => {
        const div = document.createElement('div');
        div.className = 'col-md-3 mb-3';
        div.innerHTML = `
            <div class="card">
                <img src="${url}" class="card-img-top" style="height: 150px; object-fit: cover;">
                <div class="card-body p-2 text-center">
                    <small class="text-muted">Document ${index + 1}</small>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
    
    container.style.display = uploadedUrls.length > 0 ? 'block' : 'none';
}

// Form submission
document.getElementById('recordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (uploadedUrls.length === 0) {
        alert('Please upload at least one document');
        return;
    }
    
    const formData = {
        name: document.getElementById('fullName').value,
        contact_no: document.getElementById('contactNo').value,
        address: document.getElementById('address').value,
        record_type: document.getElementById('recordType').value,
        uploaded_documents: uploadedUrls
    };
    
    // Show loading
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    submitBtn.disabled = true;
    
    // Send to Django backend
    fetch('{% url "core:ajax_create_record" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.payment_url) {
            window.location.href = data.payment_url;
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
